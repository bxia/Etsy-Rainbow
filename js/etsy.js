var _URL_ = "http://api.etsy.com/v2/public";
var _LISTING_ = "/listings/active.js";
var _KEY1_ = "&api_key=22u5zgz7eze80ymvmqshkdti";
var _KEY2_ = "&api_key=2ufyxjd5wccvgcm0yb61jp7b";
var _KEY3_ = "&api_key=hr7dbzisuo6y56soguanj071";
var a,b;
var OK = 1;
var ERR = -1;
var INVALID_URL = "Invalid etsy url. Can't proceed to ajax request";
var SUCC_MSG = "Ajax request succeeded";
var FAIL_MSG = "Ajax request failed";
var color_accuracy = 20;
var searchLimit = 30;
var resultCache = new Object();
var storedImages = new Array();

//when_made
var vintages = [
    "1980s", "1970s", "1960s", "1950s", "1940s", "1930s", "1920s", "1910s", "1900s", "1800s", "1700s", "before_1700"
];

//who_made
var I_DID = "i_did";

/*
*  A class represents a filter in accordance to html form
   This will then be rendered and sent as a request to etsy.com to retrieve cooresponding products
*/
function Filter () {
    this.color = undefined;//hsv string,required
    
    //all options below are optional
    this.keyword = undefined;
    this.category = undefined;
    this.filterType = undefined;
    this.minPrice = undefined;
    this.maxPrice = undefined;
}

Filter.prototype.key = function() {
    return this.color+this.keyword+
            "min:"+ this.minPrice +
            "max:"+ this.maxPrice +
            "type:"+this.filterType +
            "category:"+this.category;
};


/*
    Send one ajax request to etsy.com with the given request parameter and callback function
    request should be of the following form
    request = {
        requestURL : ""  //typeof String, the url to send, generated by prepareURL()
        requestOBJ : obj //typeof Filter, the filter that holds the request specification
        requestGRID: obj //typeof Object, the grid that holds the grid that initiated the request

    }
*/
function sendRequest(request,callback) {
    if(request === undefined
        || request.requestURL===undefined
        || request.requestOBJ===undefined) 
        return;
    var etsyURL = request.requestURL;
    $.ajax({
        url: etsyURL,
        dataType: 'jsonp',
        success: function(data) {
            if (data.ok){
                callback(data,request);
            }
            else
                err(data);
        }
        
    });


}


/*
 * Takes in a filter object that specifies the details of the query, and convert it into a request url
    obj is required, typeof Filter
 */
function prepareURL (obj,grid,i) {
    //category and type are processed after the query,so they are not embedded in the request url
    //only color is required
    var key = (i===1)? _KEY1_ : ((i===2)? _KEY2_: ((i===3)? _KEY3_: "") );
    var url = _URL_ + _LISTING_ + "?" + key;
    if(obj === undefined) return;
    if(obj.color === undefined) return; 
    if(obj.keyword !== undefined && obj.keyword.trim().length >0){
        url+= "&keyword="+obj.keyword.trim();
    }
    if(obj.minPrice !== undefined){
        var minPrice = obj.minPrice.trim();
        if(isNumber(minPrice)){
            minPrice = parseFloat(minPrice);
            if(minPrice>=0 && minPrice < Number.MAX_VALUE)
                url+= "&min_price="+minPrice;
        }
    }
    if(obj.maxPrice !== undefined){
        var maxPrice = obj.maxPrice.trim();
        if(isNumber(maxPrice)){
            maxPrice = parseFloat(maxPrice);
            if(maxPrice>=0 && maxPrice < Number.MAX_VALUE
                && (minPrice===undefined || minPrice <= maxPrice))
                url+= "&max_price="+maxPrice;
        }
    }
    url+= "&color="+obj.color.trim();
    url+="&color_accuracy=" + color_accuracy;
    url+="&limit=" + searchLimit;
    url+="&includes=Images:1";
    console.log(url);
    return {
        requestURL : url,
        requestOBJ : obj,
        requestGRID: grid
    };

}


/*
* Checked if this filter obj is cached
*/
function isCached (obj) {
    return obj!==undefined && resultCache[obj.key()]!==undefined;
}

/*
* Put the obj into the cache 
*/
function cache(obj,result){
    if(obj===undefined) return;
    resultCache[obj.key()] = result;
}

/*
* Read the result for the given obj from the cache
*/
function readFromCache (obj) {
    if(obj === undefined) return undefined;
    return resultCache[obj.key()];
}


/*
*   Takes in an object sent back from etsy.com with listings.
*   Return the most popular listings under the given filter, or undefined if no item found.
*/
function findMostPopular (data,filter) {
    if(data.count <= 0)
        return undefined;
    var l = data.results;
    var result = undefined; //the most popular listing to return for display.

    for(var i =0;i<l.length; i++){

        var o = l[i];
        
        var is_supply = o.is_supply;
        var when_made = o.when_made;
        var who_made = o.who_made;
        var num_favorers = o.num_favorers;
        var category = o.category_path[0].toLowerCase();
        var price = o.price;
        var type = filter.filterType;
        var cat  = filter.category;
        if(
            //image can't be duplicate
            storedImages.indexOf(o.Images[0].url_75x75) === -1
            &&
            //typeMatch
            (
                type==="all" || type === undefined ||
                (type !== undefined && type.indexOf("handmade")!== -1 && who_made===I_DID ) ||
                (type !== undefined && type.indexOf("vintage") !== -1 && vintages.indexOf(when_made) !== -1) ||
                (type !== undefined && type.indexOf("supplies")!== -1 && is_supply=== "true")
            )
            &&
            //categoryMatch
            (
                cat === "all" || cat === undefined || (cat != undefined && cat.indexOf(category)!== -1)
            )
            &&
            //price range match
            (
                (filter.minPrice===undefined && filter.maxPrice === undefined) ||
                (filter.minPrice !== undefined && isNumber(filter.minPrice) && parseFloat(price)>=parseFloat(filter.minPrice)
                    && filter.maxPrice !== undefined && isNumber(filter.maxPrice) && parseFloat(price) <= parseFloat(filter.maxPrice)) 

            )
            //num_favorer check
            &&
            (
                result === undefined || //currently no matching item yet
                result.num_favorers === undefined ||
                (num_favorers !== undefined && isNumber(num_favorers) &&
                    parseFloat(num_favorers) > parseFloat(result.num_favorers))
            )
            
        )
        {
            result = o;
        } 
    }
    storedImages.push(result.Images[0].url_75x75);
    return result;
}


/*
* Check if n is a number
*/
function isNumber(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}


/*
* Get the result(the hottest item) for display given the filter specification
*/
// function getAllListings(filter) {
//     if(filter === undefined) return undefined;

//     if(!isCached(filter))
//         sendRequest(prepareURL(filter), process);
//     return readFromCache(filter);   

// }


    // request = {
    //     requestURL : ""  //typeof String, the url to send, generated by prepareURL()
    //     requestOBJ : obj //typeof Filter, the filter that holds the request specification
    //     requestGRID: obj //typeof Object, the grid that holds the grid that initiated the request

    // }
function updateOneGrid(data,request){
    var grid = request.requestGRID;
    var filter = request.requestOBJ;
    var result = findMostPopular(data,filter);
    if(result === undefined){
        grid.el.html("<img/>");
    }
    else{
        grid.el.html("<img src='"+ result.Images[0].url_75x75 +"'/>");
    }

}   

function run () {
    storedImages = new Array();
    var filter = new Filter();
    // filter.color = "0,100,60";
    filter.keyword = "book";
    // filter.minPrice = "15.00";
    // filter.maxPrice = "30.00";
    var result;
    //send one request and read the cache till the request in done
    // sendRequest(prepareURL(filter),process);
    // var id = setInterval(function () {
    //     if(readFromCache(filter) !== undefined){
    //         clearInterval(id);
    //         console.log("break");
    //         console.log(resultCache);
    //         console.log(readFromCache(filter)); 
    //         console.log(findMostPopular(readFromCache(filter),filter));
    //     }    
    // }, 500);
    var allGrids = new Array();

    $.each(grids, function(index, value) {
        // get hsl value of this grid
        var gridId = value.id;
        var hsl = getHsl(gridId, frame);
        var hslStr = Math.floor(hsl[0]) + "," + 
                     Math.floor(hsl[1]) + "," +
                     Math.floor(hsl[2]);


        var element = $(this);

        // scale hsl, convert to hsv and scale back
        var hsv = hsl2hsv(hsl[0], hsl[1]/100, hsl[2]/100);
        hsv = [hsv[0], hsv[1]*100, hsv[2]*100];
        hsv[0] = Math.floor(hsv[0]);
        hsv[1] = Math.floor(hsv[1]);
        hsv[2] = Math.floor(hsv[2]);

        var rgb = hslToRgb(hsl[0]/360, hsl[1]/100, hsl[2]/100);
        var rgbStr = "rgb(" + 
                     Math.floor(rgb[0]) + ", " + 
                     Math.floor(rgb[1]) + ", " + 
                     Math.floor(rgb[2]) + ")";
        
        allGrids.push({
            id : gridId,
            color : hsv[0]+","+hsv[1]+","+hsv[2],
            el : element
        });
    });

    // for(var i =0;i<allGrids.length;i++){
    //     var filter = new Filter();
    //     filter.color = allGrids[i].color;
    //     filter.keyword = "book";
    //     // setTimeout(sendRequest(prepareURL(filter),updateOneGrid), i*250);
    //     setTimeout(console.log(allGrids[i]), i*2150);

    // }
    var i1=0, i2=16,i3 = 32;
    
    var loadId1 = setInterval(function() {
        if(i1>=16){
            clearInterval(loadId1);
        }
        else{
            var grid = allGrids[i1];
            var filter = new Filter();
            filter.color = grid.color;
            filter.keyword=  "book";
            sendRequest(prepareURL(filter,grid,1),updateOneGrid);
            
            i1++;
        }
    },205);

    var loadId2 = setInterval(function() {
        if(i2>=32){
            clearInterval(loadId1);
        }
        else{
            var grid = allGrids[i2];
            var filter = new Filter();
            filter.color = grid.color;
            filter.keyword=  "book";
            sendRequest(prepareURL(filter,grid,2),updateOneGrid);
            
            i2++;
        }
    },205);

    var loadId3 = setInterval(function() {
        if(i3>=48){
            clearInterval(loadId1);
        }
        else{
            var grid = allGrids[i3];
            var filter = new Filter();
            filter.color = grid.color;
            filter.keyword=  "book";
            sendRequest(prepareURL(filter,grid,3),updateOneGrid);
            
            i3++;
        }
    },205);


    

}

function println (data) {
	console.log(data);
}

function err(data){
    console.log(FAIL_MSG);
    console.log(data);
    alert(FAIL_MSG);
}
